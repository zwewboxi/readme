# 26.1月汇报 Qwen3-VL

## **1. 模型架构**
<img src="images/qwen3vl_arc.jpg" width="90%">

## **2. 2D-RoPE计算详解**

### 一、参数设定
- **嵌入维度**：`d_model = 8`（实际常用768、1024等）
- **频率基数**：`base = 10000`（行和列通常使用相同基数，也可不同）
- **测试位置**：
  - 位置0：`(row=1, col=2)`
  - 位置1：`(row=3, col=4)`

### 二、频率向量计算

对于维度 $i$（$0 \leq i < \text{d_model}/2$），频率计算公式为：
$$
\theta_i = \text{base}^{-2i/\text{d_model}}
$$

当 $\text{d_model}=8$ 时，共有4个频率（对应4组复数对）：

| $i$ | 计算公式 | 近似值 |
|-----|---------|-------|
| 0 | $10000^{-0/8} = 1$ | 1.0 |
| 1 | $10000^{-2/8} = 10000^{-0.25}$ | 0.1 |
| 2 | $10000^{-4/8} = 10000^{-0.5}$ | 0.01 |
| 3 | $10000^{-6/8} = 10000^{-0.75}$ | 0.001 |

### 三、旋转角度计算

对于位置 $(row, col)$，每个维度的旋转角度为：
$$
\phi_i = row \times \theta_i + col \times \theta_i
$$

**位置0 (1,2)：**
- $\phi_0^{(0)} = 1 \times 1 + 2 \times 1 = 3$
- $\phi_1^{(0)} = 1 \times 0.1 + 2 \times 0.1 = 0.3$
- $\phi_2^{(0)} = 1 \times 0.01 + 2 \times 0.01 = 0.03$
- $\phi_3^{(0)} = 1 \times 0.001 + 2 \times 0.001 = 0.003$

**位置1 (3,4)：**
- $\phi_0^{(1)} = 3 \times 1 + 4 \times 1 = 7$
- $\phi_1^{(1)} = 3 \times 0.1 + 4 \times 0.1 = 0.7$
- $\phi_2^{(1)} = 3 \times 0.01 + 4 \times 0.01 = 0.07$
- $\phi_3^{(1)} = 3 \times 0.001 + 4 \times 0.001 = 0.007$

### 四、旋转矩阵应用

将8维嵌入向量视为4个复数对：
$$
[(q_0, q_1), (q_2, q_3), (q_4, q_5), (q_6, q_7)]
$$

对每个复数对应用旋转矩阵：
$$
\begin{bmatrix}
q'_{2i} \\
q'_{2i+1}
\end{bmatrix}
=
\begin{bmatrix}
\cos \phi_i & -\sin \phi_i \\
\sin \phi_i & \cos \phi_i
\end{bmatrix}
\begin{bmatrix}
q_{2i} \\
q_{2i+1}
\end{bmatrix}
$$

等价于：
$$
\begin{aligned}
q'_{2i} &= q_{2i} \cos \phi_i - q_{2i+1} \sin \phi_i \\
q'_{2i+1} &= q_{2i} \sin \phi_i + q_{2i+1} \cos \phi_i
\end{aligned}
$$

### 五、实例计算（位置0）

**原始向量：**
$$
q = [1, 0, 0, 1, 0.5, 0.5, 1, 1]
$$

**第一组 $(i=0, \phi=3)$：**
$$
\begin{aligned}
\cos(3) &\approx -0.9899925, \quad \sin(3) \approx 0.1411200 \\
q_0' &= 1 \times (-0.9899925) - 0 \times 0.1411200 = -0.9899925 \\
q_1' &= 1 \times 0.1411200 + 0 \times (-0.9899925) = 0.1411200
\end{aligned}
$$

**第二组 $(i=1, \phi=0.3)$：**
$$
\begin{aligned}
\cos(0.3) &\approx 0.9553365, \quad \sin(0.3) \approx 0.2955202 \\
q_2' &= 0 \times 0.9553365 - 1 \times 0.2955202 = -0.2955202 \\
q_3' &= 0 \times 0.2955202 + 1 \times 0.9553365 = 0.9553365
\end{aligned}
$$

**第三组 $(i=2, \phi=0.03)$：**
$$
\begin{aligned}
\cos(0.03) &\approx 0.9995500, \quad \sin(0.03) \approx 0.0299955 \\
q_4' &= 0.5 \times 0.9995500 - 0.5 \times 0.0299955 = 0.48477725 \\
q_5' &= 0.5 \times 0.0299955 + 0.5 \times 0.9995500 = 0.51477275
\end{aligned}
$$

**第四组 $(i=3, \phi=0.003)$：**
$$
\begin{aligned}
\cos(0.003) &\approx 0.9999955, \quad \sin(0.003) \approx 0.00299999 \\
q_6' &= 1 \times 0.9999955 - 1 \times 0.00299999 = 0.99699551 \\
q_7' &= 1 \times 0.00299999 + 1 \times 0.9999955 = 1.00299549
\end{aligned}
$$

**旋转后向量：**
$$
q' = [-0.9899925, 0.1411200, -0.2955202, 0.9553365, 0.48477725, 0.51477275, 0.99699551, 1.00299549]
$$

### 六、注意力分数计算

#### 1. 计算位置1的键向量旋转

**原始键向量：**
$$
k = [0, 1, 1, 0, 0.5, 0.5, 1, 1]
$$

**旋转角度：** $\phi_0=7, \phi_1=0.7, \phi_2=0.07, \phi_3=0.007$

**旋转后键向量：**
$$
k' = [-0.6569866, 0.7539023, 0.7648422, 0.6442177, 0.4637923, 0.5337351, 0.99297554, 1.00697546]
$$

#### 2. 点积计算
$$
\text{score} = q' \cdot k' = \sum_{i=0}^{7} (q'_i \times k'_i)
$$

各项乘积：
- $(-0.9899925) \times (-0.6569866) \approx 0.650$
- $0.1411200 \times 0.7539023 \approx 0.106$
- $(-0.2955202) \times 0.7648422 \approx -0.226$
- $0.9553365 \times 0.6442177 \approx 0.615$
- $0.48477725 \times 0.4637923 \approx 0.225$
- $0.51477275 \times 0.5337351 \approx 0.275$
- $0.99699551 \times 0.99297554 \approx 0.990$
- $1.00299549 \times 1.00697546 \approx 1.010$

**总分：**
$$
0.650 + 0.106 - 0.226 + 0.615 + 0.225 + 0.275 + 0.990 + 1.010 = 3.645
$$

> 此分数已编码了两个位置的相对位置信息。

---

**动态分辨率适应、位置编码、特征融合与时间建模**

# Qwen3‑VL 处理高分辨率图像与视频的技术流程

Qwen3‑VL 在处理高分辨率图像和视频时，采用了一套精心设计的多级流程，结合了动态分辨率适应、位置编码、特征融合与时间建模等技术。下面我们以 **9376×1248 图像** 和 **视频** 为例，逐步说明其处理流程、维度变化与关键数学计算。

---

## 一、图像处理流程（以 9376×1248 为例）

### 1. 视觉编码器（Vision Encoder）
Qwen3‑VL 使用 **SigLIP‑2** 作为视觉编码器，支持动态分辨率输入。其核心步骤包括：

#### a) Patch 分割与线性投影
- **输入图像尺寸**：$H = 1248$, $W = 9376$，RGB 三通道 ⇒ 张量形状为 `(3, 1248, 9376)`。
- **Patch 大小**：假设使用 $14 \times 14$（SigLIP 常见配置）。
  - 垂直 Patch 数：$N_h = \frac{H}{14} = \frac{1248}{14} \approx 89$
  - 水平 Patch 数：$N_w = \frac{W}{14} = \frac{9376}{14} \approx 670$
  - 总 Patch 数：$N = N_h \times N_w \approx 89 \times 670 \approx 59,630$
- **线性投影**：每个 $14 \times 14 \times 3$ 的 Patch 通过一个可学习的投影矩阵 $W_p \in \mathbb{R}^{(14 \times 14 \times 3) \times D}$ 映射为 $D$ 维向量（SigLIP‑2 中 $D = 768$ 或 1024）。
  - 输入 Patch 张量形状：`(59,630, 14, 14, 3)` 展开为 `(59,630, 588)`。
  - 投影计算：$Z_0 = \text{Flatten}(Patches) \cdot W_p$ ⇒ 输出形状 `(59,630, D)`。

#### b) 位置编码：2D‑RoPE + 插值
Qwen3‑VL 采用 **2D‑RoPE**（Rotary Position Embedding）为每个 Patch 注入位置信息，并支持动态分辨率插值（CoMP 方法）：
- 对于位置 $(i,j)$ 的 Patch，其对应的 RoPE 旋转角度为：
  $$
  \theta_{i} = i \cdot \text{base}^{-\frac{2d}{D}}, \quad \theta_{j} = j \cdot \text{base}^{-\frac{2(d+1)}{D}}
  $$
  其中 $d$ 为维度索引，`base` 为旋转基数（如 10,000）。
- 由于原始模型是在固定分辨率（如 $224 \times 224$）预训练的，对于 $9376 \times 1248$ 的高分辨率，需对绝对位置嵌入进行**双线性插值**，使位置编码能适应新的长宽比。

#### c) 视觉编码器前向传播
SigLIP‑2 由多层 Transformer 块组成，每层包括：
- 多头自注意力（MSA） + RoPE 位置编码。
- 前馈网络（FFN）。
- 残差连接与 LayerNorm。

**维度变化**：
- 输入：`(59,630, D)`
- 每层输出形状不变，仍为 `(59,630, D)`，仅内部特征表示被更新。

#### d) 多层特征抽取（DeepStack）
Qwen3‑VL 引入 **DeepStack** 机制，从不同层抽取视觉特征以增强细粒度感知：
- 假设从第 $l_1, l_2, l_3$ 层抽取特征 $F_{l_1}, F_{l_2}, F_{l_3}$，形状均为 `(59,630, D)`。
- 每个特征经过独立的 **MLP merger**（两层 MLP）进行降维与对齐：
  $$
  \text{Merger}(F_l) = \sigma(F_l W_1 + b_1) W_2 + b_2
  $$
  输出形状变为 `(59,630, D')`，其中 $D'$ 为 LLM 隐藏层维度（如 4096）。

#### e) 2×2 特征压缩
为减少视觉 token 数量，将相邻的 $2 \times 2$ 个 Patch 的特征合并为 1 个视觉 token：
- 输入特征图尺寸：$89 \times 670$（对应 $N_h \times N_w$）。
- $2 \times 2$ 池化（平均或线性投影）后尺寸：$44 \times 335$ ⇒ 总视觉 token 数 $N_{\text{visual}} = 44 \times 335 \approx 14,740$。
- 输出视觉 token 张量形状：`(14,740, D')`。

#### f) 输入 LLM
视觉 token 与文本 token 拼接后输入 Qwen3 LLM：
- 最终输入序列长度 = 文本 token 数 + 14,740。
- 在长上下文版本中，总序列长度可达 256K，因此 14,740 个视觉 token 仍在容量范围内。

---

## 二、视频处理流程

视频被看作一系列图像帧，并额外加入时间建模。

### 1. 帧采样与分块
- 假设视频时长 $T$ 秒，帧率 $f$ fps。
- 采用**长度自适应采样**：根据训练阶段的序列长度限制动态调整采样帧数、fps 和最大帧数。
- 例如，对于长视频（>2 分钟），可能采样 1 fps，总帧数 $N_f = T$。

### 2. 每帧独立编码
- 每帧通过上述图像处理流程提取视觉 token。
- 设每帧得到 $M$ 个视觉 token（如上述 14,740 个），则 $N_f$ 帧共得到 $N_f \times M$ 个视觉 token。

### 3. 时间建模
#### a) 时间位置编码：Interleaved MRoPE
- Qwen3‑VL 改进 MRoPE，将时间、水平、垂直三个维度的旋转频率**交错分配**（而非分块分配），使各维度在高低频带均匀分布，提升长视频理解能力。
- 对于第 $t$ 帧、位置 $(i,j)$ 的 token，其旋转角度为三维联合编码：
  $$
  \theta_{\text{combined}} = \theta_t \oplus \theta_i \oplus \theta_j
  $$
  其中 $\oplus$ 表示维度交错的频率组合。

#### b) 显式时间戳标记
- 为每一段视频帧（如每 1 秒）插入文本时间戳 token，如 `<3.0 seconds>`。
- 时间戳作为普通文本 token 输入，使模型直接感知时间信息，替代了 Qwen2.5‑VL 中依赖绝对时间位置编码的方法。
- 优势：避免长视频中位置 id 过大、稀疏的问题，并降低对均匀帧率采样数据的依赖。

### 4. 视频特征融合
- 所有帧的视觉 token 与时间戳 token 交错拼接，形成**交错多模态序列**。
- 输入 LLM 的总序列长度 = 文本 token 数 + $N_f \times M$ + 时间戳 token 数。

### 5. 长视频适应（256K 上下文）
- 在 **Ultra‑Long‑Context Adaptation** 阶段，模型训练时序列长度扩展至 262,144。
- 视频帧数和每帧 token 数可灵活调整，确保总 token 数 ≤ 256K。
- 例如，对于 2 小时视频（7200 秒），若采样 1 fps，每帧提取 500 个视觉 token，则总视觉 token 数约为 3.6M，远超容量。此时需进一步降低帧率或每帧 token 数（如使用更粗的 patch 合并策略）。

---

## 三、关键数学计算与维度总结

| 步骤 | 输入形状 | 操作 | 输出形状 | 关键数学计算 |
|------|----------|------|----------|--------------|
| 图像分块 | (3, 1248, 9376) | 14×14 分块 | (59,630, 14, 14, 3) | $N_h = H/14, N_w = W/14$ |
| 线性投影 | (59,630, 588) | $Z = X W_p$ | (59,630, D) | $W_p \in \mathbb{R}^{588 \times D}$ |
| 2D‑RoPE | (59,630, D) | 旋转位置编码 | (59,630, D) | $\theta_i, \theta_j$ 旋转矩阵 |
| ViT 层处理 | (59,630, D) | MSA + FFN | (59,630, D) | $\text{Attention}(Q,K,V)$ |
| DeepStack 抽取 | 多层 (59,630, D) | 取第 $l_1, l_2, l_3$ 层 | $3 \times (59,630, D)$ | 选择指定层输出 |
| MLP Merger | (59,630, D) | 两层 MLP | (59,630, D') | $\sigma(XW_1+b_1)W_2+b_2$ |
| 2×2 压缩 | (89×670, D') | 相邻 2×2 合并 | (44×335, D') | 平均或线性投影 |
| 视频帧堆叠 | $N_f \times (M, D')$ | 拼接所有帧 | $(N_f \times M, D')$ | 沿序列维度 concat |
| 时间戳插入 | $(N_f \times M, D')$ | 插入文本 token | $(N_f \times M + N_{\text{ts}}, D')$ | 文本嵌入查找 |
| 输入 LLM | 总序列长度 $L$ | 与文本拼接 | $(L, D')$ | 256K 上下文支持 |

