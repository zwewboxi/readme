## 26.1月汇报  qwen3-vl

## **1.模型架构**
<img src="images/qwen3vl_arc.jpg" width = 90%>



### 2D-RoPE（旋转位置编码）计算详解
```
## 一、参数设定
- **嵌入维度**：`d_model = 8`（实际常用768、1024等）
- **频率基数**：`base = 10000`（行和列通常使用相同基数，也可不同）
- **测试位置**：
  - 位置0：`(row=1, col=2)`
  - 位置1：`(row=3, col=4)`

## 二、频率向量计算

对于维度 i（0 ≤ i < d_model/2），频率计算公式为：
θ_i = base^(-2i/d_model)

当 d_model=8 时，共有4个频率（对应4组复数对）：

| i | 计算公式 | 近似值 |
|---|---------|-------|
| 0 | 10000^(-0/8) = 1 | 1.0 |
| 1 | 10000^(-2/8) = 10000^(-0.25) | 0.1 |
| 2 | 10000^(-4/8) = 10000^(-0.5) | 0.01 |
| 3 | 10000^(-6/8) = 10000^(-0.75) | 0.001 |


## 三、旋转角度计算

对于位置 (row, col)，每个维度的旋转角度为：
φ_i = row × θ_i + col × θ_i

### 位置0 (1,2)：
```
φ₀(0)= 1×1 + 2×1 = 3
φ₁(0) = 1×0.1 + 2×0.1 = 0.3
φ₂(0) = 1×0.01 + 2×0.01 = 0.03
φ₃(0) = 1×0.001 + 2×0.001 = 0.003
```

### 位置1 (3,4)：
```
φ₀(1) = 3×1 + 4×1 = 7
φ₁(1) = 3×0.1 + 4×0.1 = 0.7
φ₂(1) = 3×0.01 + 4×0.01 = 0.07
φ₃(1)= 3×0.001 + 4×0.001 = 0.007
```

## 四、旋转矩阵应用

将8维嵌入向量视为4个复数对：
[(q₀, q₁), (q₂, q₃), (q₄, q₅), (q₆, q₇)]

对每个复数对应用旋转矩阵：

```
⎡ q'_{2i} ⎤   ⎡ cos φ_i  -sin φ_i ⎤ ⎡ q_{2i} ⎤
⎢         ⎥ = ⎢                  ⎥ ⎢        ⎥
⎣ q'_{2i+1} ⎦   ⎣ sin φ_i   cos φ_i ⎦ ⎣ q_{2i+1} ⎦
```

等价于：
```
q'_{2i} = q_{2i} cos φ_i - q_{2i+1} sin φ_i
q'_{2i+1} = q_{2i} sin φ_i + q_{2i+1} cos φ_i
```

## 五、实例计算（位置0）

### 原始向量：
q = [1, 0, 0, 1, 0.5, 0.5, 1, 1]

### 第一组 (i=0, φ=3)：
```
cos(3) ≈ -0.9899925, sin(3) ≈ 0.1411200
q₀' = 1 × (-0.9899925) - 0 × 0.1411200 = -0.9899925
q₁' = 1 × 0.1411200 + 0 × (-0.9899925) = 0.1411200
```

### 第二组 (i=1, φ=0.3)：
```
cos(0.3) ≈ 0.9553365, sin(0.3) ≈ 0.2955202
q₂' = 0 × 0.9553365 - 1 × 0.2955202 = -0.2955202
q₃' = 0 × 0.2955202 + 1 × 0.9553365 = 0.9553365
```

### 第三组 (i=2, φ=0.03)：
```
cos(0.03) ≈ 0.9995500, sin(0.03) ≈ 0.0299955
q₄' = 0.5 × 0.9995500 - 0.5 × 0.0299955 = 0.48477725
q₅' = 0.5 × 0.0299955 + 0.5 × 0.9995500 = 0.51477275
```

### 第四组 (i=3, φ=0.003)：
```
cos(0.003) ≈ 0.9999955, sin(0.003) ≈ 0.00299999
q₆' = 1 × 0.9999955 - 1 × 0.00299999 = 0.99699551
q₇' = 1 × 0.00299999 + 1 × 0.9999955 = 1.00299549
```

### 旋转后向量：
```
q' =[
    -0.9899925, 0.1411200,
    -0.2955202, 0.9553365,
    0.48477725, 0.51477275,
    0.99699551, 1.00299549
]
```

## 六、注意力分数计算

### 1. 计算位置1的键向量旋转
**原始键向量**：
k = [0, 1, 1, 0, 0.5, 0.5, 1, 1]

**旋转角度**：φ₀=7, φ₁=0.7, φ₂=0.07, φ₃=0.007

**旋转后键向量**：
```
k' = [
    -0.6569866, 0.7539023,    # i=0, φ=7
    0.7648422, 0.6442177,     # i=1, φ=0.7
    0.4637923, 0.5337351,     # i=2, φ=0.07
    0.99297554, 1.00697546    # i=3, φ=0.007
]
```

### 2. 点积计算
```
score = q' · k' = Σ(q'_i × k'_i)
```
各项乘积：
- `(-0.9899925)×(-0.6569866) ≈ 0.650`
- `0.1411200×0.7539023 ≈ 0.106`
- `(-0.2955202)×0.7648422 ≈ -0.226`
- `0.9553365×0.6442177 ≈ 0.615`
- `0.48477725×0.4637923 ≈ 0.225`
- `0.51477275×0.5337351 ≈ 0.275`
- `0.99699551×0.99297554 ≈ 0.990`
- `1.00299549×1.00697546 ≈ 1.010`

**总分**：`0.650+0.106-0.226+0.615+0.225+0.275+0.990+1.010 = 3.645`

> **注意**：此分数已编码了两个位置的相对位置信息。

## 七、相对位置编码特性

若两位置的相对偏移为 `(Δrow, Δcol) = (2, 2)`，可直接计算相对旋转矩阵 `R(Δrow, Δcol)`，将其应用于键向量后与查询向量点积，结果应与上述计算一致（忽略数值误差）。这体现了RoPE能**自然地编码相对位置信息**。

### 数学体现：
对于相对位置 `(Δrow, Δcol)`，旋转角度为：
```
φ_i(Δ) = Δrow × θ_i + Δcol × θ_i
```
两个位置编码后的点积仅依赖于相对位置，满足：
```
⟨RoPE(q, pos_m), RoPE(k, pos_n)⟩ = ⟨q, RoPE(k, pos_n - pos_m)⟩
```

## 总结
2D-RoPE通过将二维位置坐标映射为旋转角度，在复数域中对嵌入向量进行旋转，从而：
1. **绝对位置编码**：每个位置有独特的旋转模式
2. **相对位置编码**：注意力分数仅依赖于相对位置差
3. **长程衰减**：高频维度旋转更快，提供自然的位置相关性衰减
4. **线性可加性**：相对位置编码可通过旋转矩阵乘法实现

这种方法特别适用于图像、视频等二维数据结构的位置编码。
```
 
